<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AW Helpdesk FunctionFile v14</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script>
    function buildBodies() {
      const u = Office?.context?.mailbox?.userProfile || {};
      const when = new Date().toLocaleString();
      const text = `Summary: <one sentence>
Impact/Urgency: <P1|P2|P3|P4>
Users Affected: <>
Location: <>
Device: <>
Apps/Services: <>
Error Messages: <>
Start Time: <>
Steps Tried: <>
Callback: <>

Requested by: ${u.displayName || ""} ${u.emailAddress ? "(" + u.emailAddress + ")" : ""}
Timestamp: ${when}
`;
      const html = ""; // not used in dialog redirect path
      return { text, html };
    }

    function openComposeViaDialog(to, subject, text) {
      const base = "https://aewing0280.github.io/aw-helpdesk-addin/compose.html";
      const url = `${base}?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
      Office.context.ui.displayDialogAsync(
        url,
        { height: 65, width: 35, displayInIframe: false }, // pop-out window
        function (asyncResult) {
          // We don't need to keep the dialog; the page immediately redirects itself.
          // If you want, you can close after a short delay:
          try { setTimeout(() => asyncResult.value && asyncResult.value.close && asyncResult.value.close(), 2500); } catch(_){}
        }
      );
    }

    // Commands
    window.createTicket = function (event) {
      try { event?.completed(); } catch(_) {}
      const to = "support@abelwomack.com";
      const subject = "IT Support Request";
      const { text } = buildBodies();

      // Prefer native API if it works…
      try {
        if (Office?.context?.mailbox?.displayNewMessageForm) {
          Office.context.mailbox.displayNewMessageForm({ toRecipients:[to], subject, htmlBody: text });
          // also belt-and-suspenders with a dialog fallback shortly after
          setTimeout(() => openComposeViaDialog(to, subject, text), 400);
          return;
        }
      } catch(_){}

      // …otherwise go straight to dialog redirect
      openComposeViaDialog(to, subject, text);
    };

    window.openPortal = function (event) {
      try { event?.completed(); } catch(_) {}
      const url = "https://help.abelwomack.com";
      try {
        if (Office?.context?.ui?.openBrowserWindow) Office.context.ui.openBrowserWindow(url);
        else window.open(url, "_blank");
      } catch(_){}
    };

    Office.onReady(() => { console.log("[AW] FunctionFile v14 ready"); });
  </script>
</head>
<body>OK</body>
</html>
