<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AW Helpdesk FunctionFile v15</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script>
    function log(){ try{ console.log.apply(console, ["[AW]"].concat([].slice.call(arguments))); }catch(_){} }

    function buildText(){
      const u = Office?.context?.mailbox?.userProfile || {};
      const when = new Date().toLocaleString();
      return `Summary: <one sentence>
Impact/Urgency: <P1|P2|P3|P4>
Users Affected: <>
Location: <>
Device: <>
Apps/Services: <>
Error Messages: <>
Start Time: <>
Steps Tried: <>
Callback: <>

Requested by: ${u.displayName || ""} ${u.emailAddress ? "(" + u.emailAddress + ")" : ""}
Timestamp: ${when}
`;
    }

    function openComposeDialog(to, subject, bodyText){
      const base = "https://aewing0280.github.io/aw-helpdesk-addin/compose.html";
      const url = `${base}?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}&v=15`;
      Office.context.ui.displayDialogAsync(
        url,
        { height: 65, width: 40, displayInIframe: false }, // true=iframe; false=popup
        function (ar) {
          if (ar.status !== Office.AsyncResultStatus.Succeeded) {
            log("displayDialogAsync failed:", ar.error && ar.error.message);
            return;
          }
          const dlg = ar.value;
          log("dialog opened");
          // Listen for errors/close
          dlg.addEventHandler(Office.EventType.DialogEventReceived, function (ev) {
            log("dialog event:", JSON.stringify(ev));
          });
          // Close after a couple seconds (compose should have taken over)
          setTimeout(function(){ try{ dlg.close(); }catch(_){ }}, 3000);
        }
      );
    }

    window.createTicket = function (event) {
      try { event?.completed(); } catch(_) {}
      const to = "support@abelwomack.com";
      const subject = "IT Support Request";
      const text = buildText();

      // Native call (if honored) + dialog fallback
      try {
        if (Office?.context?.mailbox?.displayNewMessageForm) {
          Office.context.mailbox.displayNewMessageForm({ toRecipients:[to], subject, htmlBody: text });
          log("displayNewMessageForm called");
          setTimeout(function(){ openComposeDialog(to, subject, text); }, 500);
          return;
        }
      } catch(e){ log("displayNewMessageForm error:", e); }

      openComposeDialog(to, subject, text);
    };

    window.openPortal = function (event) {
      try { event?.completed(); } catch(_) {}
      const url = "https://help.abelwomack.com";
      try {
        if (Office?.context?.ui?.openBrowserWindow) Office.context.ui.openBrowserWindow(url);
        else window.open(url, "_blank");
        log("portal opened");
      } catch(e){ log("portal error:", e); }
    };

    Office.onReady(() => log("FunctionFile v15 ready"));
  </script>
</head>
<body>OK</body>
</html>
