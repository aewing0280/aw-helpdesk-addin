<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AW Helpdesk FunctionFile v13</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script>
    function awLog(m,e){try{console.log("[AW]",m,e||"")}catch(_){}}    
    function buildBodies(){
      const u=Office?.context?.mailbox?.userProfile||{}, when=new Date().toLocaleString();
      const text=`Summary: <one sentence>
Impact/Urgency: <P1|P2|P3|P4>
Users Affected: <>
Location: <>
Device: <>
Apps/Services: <>
Error Messages: <>
Start Time: <>
Steps Tried: <>
Callback: <>

Requested by: ${u.displayName||""} ${u.emailAddress?("("+u.emailAddress+")"):""}
Timestamp: ${when}
`;
      const html=`<div style="font-family:Segoe UI,Arial,sans-serif;font-size:12.5pt;line-height:1.35">
  <p><b>Summary:</b> &lt;one sentence&gt;</p>
  <p><b>Impact/Urgency:</b> &lt;P1|P2|P3|P4&gt;</p>
  <p><b>Users Affected:</b> &lt;&gt;</p>
  <p><b>Location:</b> &lt;&gt;</p>
  <p><b>Device:</b> &lt;&gt;</p>
  <p><b>Apps/Services:</b> &lt;&gt;</p>
  <p><b>Error Messages:</b> &lt;&gt;</p>
  <p><b>Start Time:</b> &lt;&gt;</p>
  <p><b>Steps Tried:</b><br>• &lt;&gt;<br>• &lt;&gt;</p>
  <p><b>Callback:</b> &lt;phone or Teams handle&gt;</p>
</div>`;
      return {text, html};
    }

    function openDeeplink(to, subject, text){
      const url=`https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
      try {
        if (Office?.context?.ui?.openBrowserWindow) { Office.context.ui.openBrowserWindow(url); }
        else { window.open(url, "_blank"); }
        awLog("fallback: deeplink opened");
      } catch(e) {
        try { window.open('mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subject),'_blank'); awLog("fallback: mailto"); } catch(e2){ awLog("fallback failed",e2); }
      }
    }

    window.createTicket=function(event){
      try{event?.completed();}catch(_){}
      const to="support@abelwomack.com", subject="IT Support Request";
      const {text, html}=buildBodies();

      // Try native compose
      try {
        if (Office?.context?.mailbox?.displayNewMessageForm){
          Office.context.mailbox.displayNewMessageForm({ toRecipients:[to], subject, htmlBody: html });
          awLog("displayNewMessageForm called");
        } else {
          awLog("displayNewMessageForm not available");
        }
      } catch(e){ awLog("displayNewMessageForm error",e); }

      // Belt-and-suspenders: if OWA ignored the call, open deeplink shortly after
      setTimeout(function(){ openDeeplink(to, subject, text); }, 500);
    };

    window.openPortal=function(event){
      try{event?.completed();}catch(_){}
      const url="https://help.abelwomack.com";
      try {
        if (Office?.context?.ui?.openBrowserWindow) { Office.context.ui.openBrowserWindow(url); }
        else { window.open(url, "_blank"); }
        awLog("portal opened");
      } catch(e){ awLog("portal error",e); }
    };

    Office.onReady(()=>{ awLog("FunctionFile v13 ready"); });
  </script>
</head>
<body>OK</body>
</html>
