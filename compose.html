<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AW Compose Redirect (Dialog-safe)</title>
  <style>
    body{font-family:Segoe UI,Arial,sans-serif;margin:24px}
    button{font-size:14px;padding:10px 16px}
    .hint{margin-top:12px;color:#555}
    .log{margin-top:12px;color:#777;font-size:12px;white-space:pre-wrap}
  </style>
  <script>
    function qs(k,d){ const p=new URLSearchParams(location.search); return p.get(k) ?? d; }
    function log(m){ try { const el=document.getElementById('log'); el.textContent += m + "\n"; } catch(_){} }

    function composeUrl(host, to, subject, body){
      return `https://${host}/mail/deeplink/compose?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    function trySequence(to, subject, body){
      const hosts = ["outlook.office365.com", "outlook.office.com"];
      let i = 0;
      function step(){
        if (i >= hosts.length) { log("All hosts attempted."); return; }
        const url = composeUrl(hosts[i], to, subject, body);
        log("Navigating: " + hosts[i]);
        try { location.href = url; } catch(e) { log("navigate error: " + e); }
        // If host 1 didn't take over, try the other after a short delay
        setTimeout(() => { i++; if (document.visibilityState !== "hidden") step(); }, 900);
      }
      step();
    }

    function openCompose(){
      const to = qs("to","support@abelwomack.com");
      const subject = qs("subject","IT Support Request");
      const body = qs("body","Describe your issue here.");
      trySequence(to, subject, body);
    }

    document.addEventListener("DOMContentLoaded", function(){
      log("Dialog ready.");
      setTimeout(openCompose, 50);           // automatic attempt (user-gesture should be intact)
      document.getElementById("go").onclick = openCompose;  // manual fallback
    });
  </script>
</head>
<body>
  <h3>Opening a new ticket composeâ€¦</h3>
  <button id="go">Open Compose Now</button>
  <div class="hint">If nothing happens in a second, click the button.</div>
  <div id="log" class="log"></div>
</body>
</html>
